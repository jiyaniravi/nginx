
user www-data;

# worker_processes : Number of processes at a time nginx could use [Max process = Number of CPU cores]
# worker_processes 2;
worker_processes auto;

load_module /etc/nginx/modules/ngx_http_image_filter_module.so;

events {
   # worker_connections : Number of requests, 1 process/core will handle at a time 
   worker_connections 1024;
}

http {

    include mime.types;

    #--------------------------------------------------------------------------------------------------
    # Request-Response buffering size timeout configurations : Start
    #--------------------------------------------------------------------------------------------------
    client_body_buffer_size 16k;
    client_header_buffer_size 1k;
    client_max_body_size 8m;
    
    client_body_timeout 1s;
    client_header_timeout 1s;

    keepalive_timeout 30s;
    send_timeout 5s;

    sendfile on;
    tcp_nopush on;
    #--------------------------------------------------------------------------------------------------
    # Request-Response buffering size timeout configurations : End
    #--------------------------------------------------------------------------------------------------

    #--------------------------------------------------------------------------------------------------
    # gzip compression configurations : Start
    #--------------------------------------------------------------------------------------------------
    gzip on;
    gzip_comp_level 3;
    gzip_types text/css text/javascript;
    #--------------------------------------------------------------------------------------------------
    # gzip compression configurations : End
    #--------------------------------------------------------------------------------------------------

    #--------------------------------------------------------------------------------------------------
    # Configure micro cache for dynamic content configurations : Start
    #--------------------------------------------------------------------------------------------------
    # Configure microcache (fastcgi)
    fastcgi_cache_path /tmp/nginx_cache levels=1:2 keys_zone=ZONE_1:100m inactive=60m;
    fastcgi_cache_key "$scheme$request_method$host$request_uri"; #Will be hashed using MD5
    add_header X-Cache $upstream_cache_status;

    #--------------------------------------------------------------------------------------------------
    # Configure micro cache for dynamic content configurations : End
    #--------------------------------------------------------------------------------------------------

    server{
        listen 80;
        server_name 172.17.160.201;

        root /home/rjiyani/projects/demo;

        #--------------------------------------------------------------------------------------------------
        # Various paths/location configurations
        #--------------------------------------------------------------------------------------------------
        #prefix match
        location /greet {
            return 200 'Hello from nginx any location starting with /greet';
        }

        #exact match
        location = /greet {
            return 200 'Hello from nginx exact /greet location';
        }

        #regex match, it is case sensitive - use of pcre lib
        location ~ /greet[0-9] {
            return 200 'Hello from nginx regex /greet location';
        }

        #regex match, it is case insensitive - use of pcre lib
         location ~* /greet[0-9] {
             return 200 'Hello from nginx regex /greet location : Case insensetive';
         }

        #Preferential prefix modifier
        location ^~ /Greet2 {
            return 200 'Hello from nginx Preferential prefix modifier /Greet2 location';
        }


        #--------------------------------------------------------------------------------------------------
        # Inspect variable values and query parameters in URL
        #--------------------------------------------------------------------------------------------------
        location /inspect {
            return 200 "$host\n$uri\n$args\n$arg_name";
        }


        #--------------------------------------------------------------------------------------------------
        # Check static API Key
        #--------------------------------------------------------------------------------------------------
        location /validate_login {
            if ( $arg_apikey != 12345 ){
                return 401 'Unauthorised Call!';        
            }

            return 200 'Authorised Call!';
        }

        #--------------------------------------------------------------------------------------------------
        # Create custom variable, change value, use in response 
        #--------------------------------------------------------------------------------------------------
        set $is_weekend 'No';
        if ( $date_local ~ 'Saturday|Sunday' ){
            set $is_weekend 'Yes';
        }
        location /is_weekend {
            return 200 'Is weekend : $is_weekend';
        }

        #--------------------------------------------------------------------------------------------------
        # Redirect/return URL response to another path 
        #--------------------------------------------------------------------------------------------------
        location /logo {
            return 307 /thumb.png;
        }

        #--------------------------------------------------------------------------------------------------
        # Rewrite URL path
        #--------------------------------------------------------------------------------------------------
        # rewrite ^/user/\w+ /greet;
        rewrite ^/user/(\w+) /greet/$1 last;
        rewrite ^/greet/ravi /thumb.png;
        location = /greet/ravi {
            return 200 "Hello Ravi";
        }

        #--------------------------------------------------------------------------------------------------
        # try_files check for existance of file, if it exists irrespective of URL it will be served
        #--------------------------------------------------------------------------------------------------
        #try_files /thumb.png /greet;
        try_files /cat.png /greet;

        #--------------------------------------------------------------------------------------------------
        # Create custom access log file based on URL
        #--------------------------------------------------------------------------------------------------
        location /secure {
            access_log /var/log/nginx/secure.access.log;
            access_log /var/log/nginx/access.log;   # To get access log entries in more than one file
            return 200 "This location is secure!";
        }

        #--------------------------------------------------------------------------------------------------
        # Stop access logs for specific URLs/Files
        #--------------------------------------------------------------------------------------------------
        location /font_files {
            access_log off;
            return 200 "These are the fonts!";
        }
    }

    # Redirect all http traffic to https 
    server {
        listen *:80;
        server_name 192.168.85.29;
        return 301 https://$server_name/$request_uri;
    }

    server{
        #listen 80;   
        listen 443 ssl http2;
        ssl_certificate /etc/nginx/ssl/self.crt;
        ssl_certificate_key /etc/nginx/ssl/self.key;

        server_name 192.168.85.29;
        root /home/rjiyani/projects/php-demo;

        index index.php index.html;

        if ($arg_skipcache = 1){
            set $no_cache 1;
        }

        location = /index.html {
            http2_push /style.css;
            http2_push /thumb.png;
        }

        location / {
            try_files $uri $uri/ =404;
        }

        location ~\.php$ {
            # Pass php requests to php-fpm service (fastcgi) 
            # Make sure php${version}-fpm service is up and running in your machine
            include fastcgi.conf;
            fastcgi_pass unix:/run/php/php7.4-fpm.sock;

            # Enable Cache
            fastcgi_cache ZONE_1;
            fastcgi_cache_valid 200 60m; # This is example of an array directive, which can be used multiple times in same context
            fastcgi_cache_valid 404 10m;

            fastcgi_cache_bypass $no_cache;
            fastcgi_no_cache $no_cache;
        }

        location ~* \.(css|js|jpg|png)$ {
            # image_filter rotate 180;
            # add_header my_header "Hello Ravi!";

            access_log off;
            add_header Cache-Control public;
            add_header Pragma public;
            add_header Vary Accept-Encoding;
            expires 1M;
        }
    }
}
